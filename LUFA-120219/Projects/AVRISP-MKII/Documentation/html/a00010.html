<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>AVRISP-MKII Clone Programmer Project: Lib/ISP/ISPTarget.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript">
function hasClass(ele,cls) {
  return ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
}

function addClass(ele,cls) {
  if (!this.hasClass(ele,cls)) ele.className += " "+cls;
}

function removeClass(ele,cls) {
  if (hasClass(ele,cls)) {
    var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
    ele.className=ele.className.replace(reg,' ');
  }
}

function toggleVisibility(linkObj) {
 var base = linkObj.getAttribute('id');
 var summary = document.getElementById(base + '-summary');
 var content = document.getElementById(base + '-content');
 var trigger = document.getElementById(base + '-trigger');
 if ( hasClass(linkObj,'closed') ) {
   summary.style.display = 'none';
   content.style.display = 'block';
   trigger.src = 'open.png';
   removeClass(linkObj,'closed');
   addClass(linkObj,'opened');
 } else if ( hasClass(linkObj,'opened') ) {
   summary.style.display = 'block';
   content.style.display = 'none';
   trigger.src = 'closed.png';
   removeClass(linkObj,'opened');
   addClass(linkObj,'closed');
 }
 return false;
}
</script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">AVRISP-MKII Clone Programmer Project&#160;<span id="projectnumber">0.0.0</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('a00010.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">ISPTarget.c File Reference</div>  </div>
</div>
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="a00011.html">ISPTarget.h</a>&quot;</code><br/>
</div><table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a7f2b28d5e226868e7b0c05f2e95d0e6e">ISR</a> (TIMER1_COMPA_vect, ISR_BLOCK)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#acff2212c4069d0bf6601f244ecff2896">ISPTarget_EnableTargetISP</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#ada29eafa3b95fb8b8d018cae1482369c">ISPTarget_DisableTargetISP</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a9a9a7c03e14b7995ca07f36777e941d3">ISPTarget_ConfigureRescueClock</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a1e646203c9d78cc22000b99bfc0b0749">ISPTarget_ConfigureSoftwareSPI</a> (const uint8_t SCKDuration)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a85f2cb599a594ecbcd29188b6e7fe3a0">ISPTarget_TransferSoftSPIByte</a> (const uint8_t Byte)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a864f4bd8811919d85a41134a67ff6a5a">ISPTarget_ChangeTargetResetLine</a> (const bool ResetTarget)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#ab2b8bba70c1a86680d5c5f18e0037fa7">ISPTarget_WaitWhileTargetBusy</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a01513e91f91229d2055fab67ecb7e97a">ISPTarget_LoadExtendedAddress</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#aa9b80cf2116c32a9ae50c32d94b661d1">ISPTarget_WaitForProgComplete</a> (const uint8_t ProgrammingMode, const uint16_t PollAddress, const uint8_t PollValue, const uint8_t DelayMS, const uint8_t ReadMemCommand)</td></tr>
<tr><td colspan="2"><h2><a name="var-members"></a>
Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a557e037011da66be798343d295c449a8">SPIMaskFromSCKDuration</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const uint16_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a1087046db07a69f8706768b379f143e2">TimerCompareFromSCKDuration</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a8786b5219e01da078c86e99ebadcbd33">HardwareSPIMode</a> = true</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static volatile uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a9f0f847a083c29bfa66548960c1b8513">SoftSPI_Data</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static volatile uint8_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="a00010.html#a4fdb0680f47b00fe9ddc8d15e39a5162">SoftSPI_BitsRemaining</a></td></tr>
</table>
<hr/><a name="details" id="details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Target-related functions for the ISP Protocol decoder. </p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="a864f4bd8811919d85a41134a67ff6a5a"></a><!-- doxytag: member="ISPTarget.c::ISPTarget_ChangeTargetResetLine" ref="a864f4bd8811919d85a41134a67ff6a5a" args="(const bool ResetTarget)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ISPTarget_ChangeTargetResetLine </td>
          <td>(</td>
          <td class="paramtype">const bool&#160;</td>
          <td class="paramname"><em>ResetTarget</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Asserts or deasserts the target's reset line, using the correct polarity as set by the host using a SET PARAM command. When not asserted, the line is tristated so as not to interfere with normal device operation.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">ResetTarget</td><td>Boolean true when the target should be held in reset, false otherwise </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="a9a9a7c03e14b7995ca07f36777e941d3"></a><!-- doxytag: member="ISPTarget.c::ISPTarget_ConfigureRescueClock" ref="a9a9a7c03e14b7995ca07f36777e941d3" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ISPTarget_ConfigureRescueClock </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Configures the AVR to produce a 4MHz rescue clock out of the OCR1A pin of the AVR, so that it can be fed into the XTAL1 pin of an AVR whose fuses have been mis-configured for an external clock rather than a crystal. When used, the ISP speed must be 125KHz for this functionality to work correctly. </p>

</div>
</div>
<a class="anchor" id="a1e646203c9d78cc22000b99bfc0b0749"></a><!-- doxytag: member="ISPTarget.c::ISPTarget_ConfigureSoftwareSPI" ref="a1e646203c9d78cc22000b99bfc0b0749" args="(const uint8_t SCKDuration)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ISPTarget_ConfigureSoftwareSPI </td>
          <td>(</td>
          <td class="paramtype">const uint8_t&#160;</td>
          <td class="paramname"><em>SCKDuration</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Configures the AVR's timer ready to produce software SPI for the slower ISP speeds that cannot be obtained when using the AVR's hardware SPI module.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">SCKDuration</td><td>Duration of the desired software ISP SCK clock </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="ada29eafa3b95fb8b8d018cae1482369c"></a><!-- doxytag: member="ISPTarget.c::ISPTarget_DisableTargetISP" ref="ada29eafa3b95fb8b8d018cae1482369c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ISPTarget_DisableTargetISP </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Shuts down the current selected SPI driver (hardware or software, depending on the selected ISP speed) so that no further communications can occur until the driver is re-initialized. </p>

</div>
</div>
<a class="anchor" id="acff2212c4069d0bf6601f244ecff2896"></a><!-- doxytag: member="ISPTarget.c::ISPTarget_EnableTargetISP" ref="acff2212c4069d0bf6601f244ecff2896" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ISPTarget_EnableTargetISP </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Initializes the appropriate SPI driver (hardware or software, depending on the selected ISP speed) ready for communication with the attached target. </p>

</div>
</div>
<a class="anchor" id="a01513e91f91229d2055fab67ecb7e97a"></a><!-- doxytag: member="ISPTarget.c::ISPTarget_LoadExtendedAddress" ref="a01513e91f91229d2055fab67ecb7e97a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ISPTarget_LoadExtendedAddress </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Sends a low-level LOAD EXTENDED ADDRESS command to the target, for addressing of memory beyond the 64KB boundary. This sends the command with the correct address as indicated by the current address pointer variable set by the host when a SET ADDRESS command is issued. </p>

</div>
</div>
<a class="anchor" id="a85f2cb599a594ecbcd29188b6e7fe3a0"></a><!-- doxytag: member="ISPTarget.c::ISPTarget_TransferSoftSPIByte" ref="a85f2cb599a594ecbcd29188b6e7fe3a0" args="(const uint8_t Byte)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t ISPTarget_TransferSoftSPIByte </td>
          <td>(</td>
          <td class="paramtype">const uint8_t&#160;</td>
          <td class="paramname"><em>Byte</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Sends and receives a single byte of data to and from the attached target via software SPI.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">Byte</td><td>Byte of data to send to the attached target</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Received byte of data from the attached target </dd></dl>

</div>
</div>
<a class="anchor" id="aa9b80cf2116c32a9ae50c32d94b661d1"></a><!-- doxytag: member="ISPTarget.c::ISPTarget_WaitForProgComplete" ref="aa9b80cf2116c32a9ae50c32d94b661d1" args="(const uint8_t ProgrammingMode, const uint16_t PollAddress, const uint8_t PollValue, const uint8_t DelayMS, const uint8_t ReadMemCommand)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t ISPTarget_WaitForProgComplete </td>
          <td>(</td>
          <td class="paramtype">const uint8_t&#160;</td>
          <td class="paramname"><em>ProgrammingMode</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint16_t&#160;</td>
          <td class="paramname"><em>PollAddress</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint8_t&#160;</td>
          <td class="paramname"><em>PollValue</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint8_t&#160;</td>
          <td class="paramname"><em>DelayMS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const uint8_t&#160;</td>
          <td class="paramname"><em>ReadMemCommand</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Waits until the last issued target memory programming command has completed, via the check mode given and using the given parameters.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">ProgrammingMode</td><td>Programming mode used and completion check to use, a mask of <code>PROG_MODE_*</code> constants </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">PollAddress</td><td>Memory address to poll for completion if polling check mode used </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">PollValue</td><td>Poll value to check against if polling check mode used </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">DelayMS</td><td>Milliseconds to delay before returning if delay check mode used </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ReadMemCommand</td><td>Device low-level READ MEMORY command to send if value check mode used</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>V2 Protocol status <a class="el" href="a00014.html#a2c06f068c4eac3fff24312e002868fa1">STATUS_CMD_OK</a> if the no timeout occurred, <a class="el" href="a00014.html#aa6d5ea133f198c3501c524b50f24c063">STATUS_RDY_BSY_TOUT</a> or <a class="el" href="a00014.html#a4266794d90c4c551f31efecb2e0b3368">STATUS_CMD_TOUT</a> otherwise </dd></dl>

</div>
</div>
<a class="anchor" id="ab2b8bba70c1a86680d5c5f18e0037fa7"></a><!-- doxytag: member="ISPTarget.c::ISPTarget_WaitWhileTargetBusy" ref="ab2b8bba70c1a86680d5c5f18e0037fa7" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint8_t ISPTarget_WaitWhileTargetBusy </td>
          <td>(</td>
          <td class="paramtype">void&#160;</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Waits until the target has completed the last operation, by continuously polling the device's BUSY flag until it is cleared, or until the command timeout period has expired.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>V2 Protocol status <a class="el" href="a00014.html#a2c06f068c4eac3fff24312e002868fa1">STATUS_CMD_OK</a> if the no timeout occurred, <a class="el" href="a00014.html#aa6d5ea133f198c3501c524b50f24c063">STATUS_RDY_BSY_TOUT</a> otherwise </dd></dl>

</div>
</div>
<a class="anchor" id="a7f2b28d5e226868e7b0c05f2e95d0e6e"></a><!-- doxytag: member="ISPTarget.c::ISR" ref="a7f2b28d5e226868e7b0c05f2e95d0e6e" args="(TIMER1_COMPA_vect, ISR_BLOCK)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">ISR </td>
          <td>(</td>
          <td class="paramtype">TIMER1_COMPA_vect&#160;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ISR_BLOCK&#160;</td>
          <td class="paramname">&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>ISR to handle software SPI transmission and reception </p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a8786b5219e01da078c86e99ebadcbd33"></a><!-- doxytag: member="ISPTarget.c::HardwareSPIMode" ref="a8786b5219e01da078c86e99ebadcbd33" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool <a class="el" href="a00011.html#a8786b5219e01da078c86e99ebadcbd33">HardwareSPIMode</a> = true</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Currently selected SPI driver, either hardware (for fast ISP speeds) or software (for slower ISP speeds). </p>

</div>
</div>
<a class="anchor" id="a4fdb0680f47b00fe9ddc8d15e39a5162"></a><!-- doxytag: member="ISPTarget.c::SoftSPI_BitsRemaining" ref="a4fdb0680f47b00fe9ddc8d15e39a5162" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint8_t <a class="el" href="a00010.html#a4fdb0680f47b00fe9ddc8d15e39a5162">SoftSPI_BitsRemaining</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Number of bits left to transfer in the software SPI driver </p>

</div>
</div>
<a class="anchor" id="a9f0f847a083c29bfa66548960c1b8513"></a><!-- doxytag: member="ISPTarget.c::SoftSPI_Data" ref="a9f0f847a083c29bfa66548960c1b8513" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">volatile uint8_t <a class="el" href="a00010.html#a9f0f847a083c29bfa66548960c1b8513">SoftSPI_Data</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Software SPI data register for sending and receiving </p>

</div>
</div>
<a class="anchor" id="a557e037011da66be798343d295c449a8"></a><!-- doxytag: member="ISPTarget.c::SPIMaskFromSCKDuration" ref="a557e037011da66be798343d295c449a8" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const uint8_t <a class="el" href="a00010.html#a557e037011da66be798343d295c449a8">SPIMaskFromSCKDuration</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>List of hardware SPI prescaler masks for possible AVRStudio ISP programming speeds. </p>

</div>
</div>
<a class="anchor" id="a1087046db07a69f8706768b379f143e2"></a><!-- doxytag: member="ISPTarget.c::TimerCompareFromSCKDuration" ref="a1087046db07a69f8706768b379f143e2" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const uint16_t <a class="el" href="a00010.html#a1087046db07a69f8706768b379f143e2">TimerCompareFromSCKDuration</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Lookup table to convert the slower ISP speeds into a compare value for the software SPI driver. </p>

</div>
</div>
</div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="a00010.html">ISPTarget.c</a>      </li>
      <li class="footer">Generated by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </li>
    </ul>
  </div>

</body>
</html>
